{% extends "fullscreen.html" %}
{% load i18n %}

{% block title %} {{maptitle}}{% endblock %}

{% block head %}
{% include "geonode/ext_header.html" %}
{% include "geonode/app_header.html" %}
{% include "geonode/geo_header.html" %}
<script type="text/javascript" src="{{ GEONODE_CLIENT_LOCATION }}externals/misc/nicEdit.js"></script>
<script src="http://www.google.com/jsapi?client={{GOOGLE_API_KEY}}"></script>





<script type="text/javascript">
    google.load("earth", "1");


</script>


<link rel="stylesheet" type="text/css" href="{{ GEONODE_CLIENT_LOCATION }}theme/ux/colorpicker/color-picker.ux.css" />
<style type="text/css">
    #templates { display: none; }
</style>

<script src="{{ GEONODE_CLIENT_LOCATION }}script/PrintPreview.js"></script>
<link rel="stylesheet" type="text/css" href="{{ GEONODE_CLIENT_LOCATION }}externals/PrintPreview/resources/css/printpreview.css" />
<script src="{{GEOSERVER_BASE_URL}}pdf/info.json?var=printCapabilities" type="text/javascript"></script>
{{ block.super }}

<script type="text/javascript">

Ext.sequence( Ext.form.SliderField.prototype, 'initComponent', function() {
    this.slider.on( 'change', this.fireEvent.createDelegate( this, 'change', 0 ) );
    this.slider.on( 'changecomplete', this.fireEvent.createDelegate( this, 'changecomplete', 0 ) );

});

Ext.override(Ext.form.SliderField, {
    onDrag:  function(e) {
    var pos = this.innerEl.translatePoints(this.tracker.getXY());
    this.setValue(Ext.util.Format.round(this.reverseValue(pos.left), this.decimalPrecision), false);
    this.fireEvent('drag', this, e);
    }
});

function get_cookie(c_name) {
    if (document.cookie.length <= 0)
        return "";

    c_start = document.cookie.indexOf(c_name + "=");
    if (c_start == -1)
        return "";

    c_start = c_start + c_name.length + 1;
    c_end = document.cookie.indexOf(";", c_start);
    if (c_end == -1)
        c_end = document.cookie.length;
    return unescape(document.cookie.substring(c_start, c_end));
}

function delete_cookie(name)
{
    document.cookie = name + '=; Domain=.harvard.edu; Path=/; expires=Monday, 19-Aug-1996 05:00:00 GMT';
}


/* Override Layer.Grid method for twitter heatmap */

OpenLayers.Layer.Grid.newRatio = 1.5;



gxp.plugins.LayerManager.prototype.configureLayerNode = function(loader,attr) {

    var legendXType;
    // add a WMS legend to each node created
    if (attr.layer.url &&  attr.layer.url.indexOf("{{GEOPS_IP}}") > -1) {
        if (attr.layer.params.LAYERS == "heatmap") {
            legendXType = "gx_geopslegend";
        } else
        return;
    } else if (OpenLayers.Layer.WMS && attr.layer instanceof OpenLayers.Layer.WMS) {
        legendXType = "gx_wmslegend";
    }
    gxp.plugins.LayerManager.superclass.configureLayerNode.apply(this, arguments);
    if (legendXType) {
        Ext.apply(attr, {
            component: {
                xtype: legendXType,
                // TODO these baseParams were only tested with GeoServer,
                // so maybe they should be configurable - and they are
                // only relevant for gx_wmslegend.
                baseParams: {
                    transparent: true,
                    format: "image/png",
                    legend_options: "fontAntiAliasing:true;fontSize:11;fontName:Arial"
                },
                layerRecord: this.target.mapPanel.layers.getByLayer(attr.layer),
                showTitle: false,
                // custom class for css positioning
                // see tree-legend.html
                cls: "legend"
            }
        });
    }


};


OpenLayers.Layer.Grid.prototype.setTileSize = function(size) {
    if (this.singleTile) {
        size = this.map.getSize();
        //console.log("Grid Size: " + size.toString() + " and ratio: " + this.ratio);
        var curWidth = parseInt(size.w * this.ratio);
        var targetWidth = curWidth +  (16 - (curWidth % 16));
        this.newRatio = this.ratio * (targetWidth/size.w);
        size.h = parseInt(Math.round(size.h * this.newRatio));
        size.w = parseInt(Math.round(size.w * this.newRatio));
        //console.log("In setTileSize: " + this.newRatio + ":" + size.toString());

    }
    OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this, [size]);
};

OpenLayers.Layer.Grid.prototype.initSingleTile = function(bounds) {

    //determine new tile bounds
    var center = bounds.getCenterLonLat();
    var tileWidth = (bounds.getWidth() * this.newRatio);
    var tileHeight = bounds.getHeight() * this.newRatio;

    var tileBounds =
            new OpenLayers.Bounds(center.lon - (tileWidth/2),
                    center.lat - (tileHeight/2),
                    center.lon + (tileWidth/2),
                    center.lat + (tileHeight/2));

    //console.log("Grid tileBounds:" + tileBounds.toString());

    var px = this.map.getLayerPxFromLonLat({
        lon: tileBounds.left,
        lat: tileBounds.top
    });

    if (!this.grid.length) {
        this.grid[0] = [];
    }

    var tile = this.grid[0][0];
    if (!tile) {
        tile = this.addTile(tileBounds, px);

        this.addTileMonitoringHooks(tile);
        tile.draw();
        this.grid[0][0] = tile;
    } else {
        tile.moveTo(tileBounds, px);
    }

    //remove all but our single tile
    this.removeExcessTiles(1,1);

    // store the resolution of the grid
    this.gridResolution = this.getServerResolution();
};



var app;
var init = function() {
{% autoescape off %}
    var config = Ext.apply({
        tools:  [{
                    ptype: "gxp_geonodequerytool",
                    id: "worldmap_query_tool",
                    actionTarget:  {target: "paneltbar", index: 5},
                    toolText: '<span class="x-btn-text">Identify</span>',
                    iconCls: null,
                    geopsUrl: "{{GEOPS_IP}}",
                    outputConfig: {width: 400, height: 200, panIn: false},
                    featurePanel: 'queryPanel',
                    attributePanel: 'gridWinPanel',
                    toggleGroup: 'featureGroup'
                },
            {
                ptype: "gxp_coordinatetool",
                actionTarget:  {target: "paneltbar", index: 7},
                toolText: '<span class="x-btn-text">Position</span>',
                iconCls: null,
                toggleGroup: 'featureGroup',
                pressed: false
            }
        ],
        proxy: "/proxy/?url=",

        /* The URL to a REST map configuration service.  This service
         * provides listing and, with an authenticated user, saving of
         * maps on the server for sharing and editing.
         */
        rest: "/maps/",
        homeUrl: "{% url home %}",
        siteUrl: "{{ SITE_URL }}",
        localGeoServerBaseUrl: "{{ GEOSERVER_BASE_URL }}",
        csrfToken: "{{ csrf_token }}",
        authorizedRoles: "{{ user.is_authenticated|yesno:"ROLE_ADMINISTRATOR,ROLE_ANONYMOUS" }}"
    }, {{ config }});


app = new GeoExplorer(config, true);

var permalinkTemplate = new Ext.Template("{protocol}//{host}/maps/{id}/edit");
    var permalink = function(id) {
            return permalinkTemplate.apply({
                protocol: window.location.protocol,
                host: window.location.host,
                id: id
            })
        };


    var titleTemplate = new Ext.Template("<span>{title}</span>");
    Ext.DomHelper.overwrite(Ext.get("page-breadcrumb"), titleTemplate.apply({title: (config.about.officialurl ? '' : 'Current Map: ') + (config.about.title ? config.about.title : 'New Map')}));

    app.on("saved", function(id) {
        //reset title header
        Ext.DomHelper.overwrite(Ext.get("page-breadcrumb"), titleTemplate.apply({title: (config.about.officialurl ? '' : 'Current Map: ') + (config.about.title ? config.about.title : 'New Map')}));


    }, this);


    var tweetFilterField = new Ext.form.TextField({
        id: 'tweetFilter',
        name: 'tweetFilter',
        fieldLabel: "Filter Term",
        labelAlign: 'right',
        labelStyle: "text-align:right;",
        allowBlank: true,
        value: '',
        width:96
    });

    var tweetDateStartField = new Ext.ux.form.DateTime({
        id: 'tweetStartDate',
        fieldLabel: 'From',
        labelAlign: 'right',
        labelStyle:"font-weight:bold;text-align:right",
        allowBlank: false
        ,timeFormat:'H:i:s'
        ,timeConfig: {
            altFormats:'H:i:s'
            ,allowBlank:true
        }
        ,dateFormat:'n/d/Y'
        ,dateConfig: {
            altFormats:'Y-m-d|Y-n-d'
            ,allowBlank:true,
            minValue: new Date(2012,9,1),
            maxValue: new Date(Date.now()+86400000),
            value: new Date(Date.now()-(86400000*7))
         },
        width:200
    });

var tweetDateEndField = new Ext.ux.form.DateTime({
    id: 'tweetEndDate',
    //fieldLabel: 'To',
    //labelAlign: 'top',
    //labelStyle:"font-weight:bold;text-align:right",
    allowBlank: false
    ,timeFormat:'H:i:s'
    ,timeConfig: {
        altFormats:'H:i:s'
        ,allowBlank:true,
        value: new Date(Date.now())
    }
    ,dateFormat:'n/d/Y'
    ,dateConfig: {
        altFormats:'Y-m-d|Y-n-d'
        ,allowBlank:true,
        minValue: new Date(2012,9,1),
        maxValue: new Date(Date.now()+86400000),
        value: new Date(Date.now())
    },
    width:200
});


var firstEndDate =  tweetDateEndField.getValue().getTime()-1000;
var firstHeatMap = true;

var tweetPointLayer = null;
var tweetHeatLayer = null;

var chartColors = ["#FF0000", "#006600", "#0000CC", "#000000", "#FF00FF" ];
/*
var trendStoreProxy = new Ext.data.HttpProxy({
    url : "/tweettrends"
});
var remoteStore = new Ext.data.JsonStore({
    root : 'record',
    autoLoad : true,
    storeId : 'trendStore',
    proxy : trendStoreProxy,
    baseParams: { "bounds": config["map"]["maxExtent"], "dateStart": new Date(tweetDateStartField.getValue()).format('Y-M-d'), "dateEnd":  new Date(tweetDateEndField.getValue()).format('Y-M-d')},
    listeners: {
        'datachanged': function(){
            if (chart != null) {
            //create the series based on the metadata returned from the store.
            var fields = remoteStore.reader.meta.fields;
            var series = [];
            for(var i=0;i<fields.length;i++){
                // //console.log(i);
                if (fields[i].name != "date") {
                    var newSeries = new Ext.chart.LineSeries({
                        displayName: fields[i].name.replace("_"," "),
                        yField: fields[i].name,
                        style: {color: chartColors[i-1], size: 5, lineSize: 1}
                    });
                    series.push(newSeries);
                }
            }
            chart.setSeries(series);
           }
        }
    }
});
 */

//var getLegendUrl = function() {
//    return  tweetConfig.url +
//            "?TRANSPARENT=TRUE&TILED=false&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&EXCEPTIONS=application%2Fvnd.ogc.se_xml" +
//            "&LAYER=heatmap&FORMAT=image%2Fgif&SQL=" + tweetHeatRecord.getLayer().params["SQL"] + "&MAXVAL=" +  Ext.getCmp("slider_maxval").getValue() +
//            "&BLUR=" + tweetHeatRecord.getLayer().params["BLUR"] + "&MIN=" + tweetHeatRecord.getLayer().params["MIN"] +
//            "&RND=" + tweetHeatRecord.getLayer().params["RND"];
//};

var is_authorized = "{{tweetdownload}}";

var updateCQL = function(layers) {

    if (Math.floor(tweetDateEndField.getValue().getTime()) >=  Math.floor(firstEndDate)) {
        var rightNow = new Date();
        tweetDateEndField.setValue(rightNow);
    }

    var randomNum = Math.random();
    var startFilter = "SELECT goog_x, goog_y, ";


    var keywordFilter = "";
    var keywords = tweetFilterField.getValue().replace("'","''").match(/[^"\s]+|"[^"]+"/g);
    if (keywords) {
        for (var k = 0; k < keywords.length; k++) {
            keywordFilter += (k > 0? " AND ": "") +  "tweet_text ilike '" +keywords[k].replace(/["]/g,'') + "'";
        }
    }

    var timeFilter =  "time > " + (Math.floor(new Date(tweetDateStartField.getValue()).getTime()/1000)) + " AND time < " + (Math.floor(new Date(tweetDateEndField.getValue()).getTime() /1000)) ;
    var fromFilter = " from oct_tweets";

    var numLayersVisible = 0;
    for (var x = 0; x < layers.length; x++) {
        var layer = layers[x];

        layer.getLayer().params["RND"] = randomNum;

        if (layer.get("name") == "heatmap") {
            layer["cql_filter"] =  startFilter + keywordFilter +  fromFilter + " WHERE " + timeFilter;
            layer.getLayer().params["SQL"] =  layer["cql_filter"];
            layer.getLayer().params["BLUR"] = Ext.getCmp("slider_blur").value;
            layer.getLayer().params["MIN"] = Ext.getCmp("slider_min").value/100;
            layer.getLayer().params["MAXVAL"] = Ext.getCmp("auto_max_checkbox").checked ? "auto" :  Ext.getCmp("slider_maxval").value;
            if (keywords  && keywords != "") {
                layer.getLayer().setVisibility(true);
                numLayersVisible++;
                if (firstHeatMap === true)
                    firstHeatMap = false;
            } else if (!keywords || keywords == "") {
                layer.getLayer().setVisibility(false);
            }

        } else {
            layer["cql_filter"] = startFilter + " tweet_text " + fromFilter + " WHERE "  + timeFilter + (keywords ?  " AND " + keywordFilter : "") ;
            layer.getLayer().params["SQL"] = layer["cql_filter"];
            layer.getLayer().params["RADIUS"] = 1;
            layer.getLayer().params["R"] = 0;
            layer.getLayer().params["G"] = 0;
            layer.getLayer().params["B"] = 255;
            if (layer.getLayer().getVisibility() === true) {
                numLayersVisible++;
            }

        }

    }

    for (var xx = 0; xx < layers.length; xx++) {
        var layer = layers[xx];
        layer.getLayer().params["NUM_REQUESTS"] = numLayersVisible;
    }
}


var getDownloadLink = function() {

    function getUrlParams(url) {
        var params = {};
        url.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str,key,value) {
            params[key] = value;
        });

        return params;
    }

    var params = getUrlParams(tweetPointRecord.getLayer().grid[0][0].url);
    return "/tweetDownload/?LAYERS=POINT&SQL=" + params.SQL.replace(/goog_x%2C(%20)+goog_y%2C(%20)+tweet_text/g,  "lat%2C%20lon%2C%20sender_name%2C%20time%2C%20tweet_id%2C%20tweet_text") + "&BBOX=" + params.BBOX;
    //return "/tweetDownload/?LAYERS=POINT&SQL=" + params.SQL + "&BBOX=" + params.BBOX;

}

var setCurrentTime = function() {
    if (Math.floor(tweetDateEndField.getValue().getTime()) >=  Math.floor(firstEndDate)) {
        var rightNow = new Date();
        tweetDateEndField.setValue(rightNow);
        updateLayer();
    }
}




    var updateLayer =  function() {
        if (tweetDateStartField.getValue() !="" && tweetDateEndField.getValue() != "") {
        if (tweetHeatRecord != null && tweetPointRecord != null) {
            updateCQL([tweetHeatRecord,tweetPointRecord]);
            tweetHeatRecord.getLayer().redraw(true);
	        tweetPointRecord.getLayer().redraw(true);
        }



//        remoteStore.load({
//            params: {"bounds": app.mapPanel.map.getExtent() ? app.mapPanel.map.getExtent() : config["map"]["maxExtent"], "dateStart": new Date(tweetDateStartField.getValue()).format('Y-M-d'), "dateEnd" : new Date(tweetDateEndField.getValue()).format('Y-M-d')}
//        });

        }


    };

     tweetDateStartField.on("change", updateLayer);
    tweetDateEndField.on("change", updateLayer);
    tweetDateStartField.on("select", updateLayer);
    tweetDateEndField.on("select", updateLayer);

    var rewindDate = new Ext.Button({
            iconCls: "icon-zoom-previous",
            style: "display: inline-block;padding-left:5px;",
            handler: function(button,event) {
                if (tweetDateStartField.validate() && tweetDateEndField.validate()){
                    var interval = Ext.getCmp("date_interval").getValue();
                    var yesterdayStart = tweetDateStartField.getValue().add(interval, -1);
                    var yesterdayEnd = tweetDateEndField.getValue().add(interval, -1);
                    if (yesterdayStart >=  Ext.getCmp(tweetDateStartField.id + "-date").minValue) {
                        tweetDateStartField.setValue(yesterdayStart);
                        tweetDateEndField.setValue(yesterdayEnd);
                        updateLayer();
                    }
                }
            }
    });


    var forwardDate = new Ext.Button({
        iconCls: "icon-zoom-next",
        style: "display: inline-block;padding-right:5px;",
        handler: function(button,event) {
            if (tweetDateStartField.validate() && tweetDateEndField.validate()){
                var interval = Ext.getCmp("date_interval").getValue();
                var tomorrowStart = tweetDateStartField.getValue().add(interval, 1);
                var tomorrowEnd = tweetDateEndField.getValue().add(interval, 1);
                if (tomorrowEnd <= Ext.getCmp(tweetDateEndField.id + "-date").maxValue) {
                    tweetDateStartField.setValue(tomorrowStart);
                    tweetDateEndField.setValue(tomorrowEnd);
                    updateLayer();
                }
            }
        }
    });


    var updateLayerBtn = new Ext.Button({
        text: "Filter Tweets",
        handler: updateLayer
    });

    var cqlOverlay = new Ext.FormPanel({
        frame: true,
        bodyStyle: 'padding: 10px 10px 0 10px;background:transparent;',
        labelWidth: 70,
        defaults: {
            anchor: '95%',
            msgTarget: 'side'
        },
        width: 600,
        height: 140,
        layout:"fit",
        items: [
            {
                layout:"column",

                items:[
                {
                    columnWidth:0.6,
                    //layout:"form",
                    //title:"3",
                    items:[
                        {
                            xtype: "compositefield",
                            labelStyle: "text-align:right;",
                            items: [
                                {xtype: "container", width: 70, style:"align:right;padding-bottom:10px",
                                    html: "<span> Filter Term:</span>"},
                                tweetFilterField,
                                updateLayerBtn
                            ]
                        },
                        {
                            xtype: "compositefield",
                            items: [
                       // rewindDate,
                       {xtype: "container", width: 70, style:"align:right",
                                    html: "<span> From:</span>"},
                        tweetDateStartField
                          //forwardDate
                            ]
                        },
                        {xtype: "container",
                            html: "<div style='padding-bottom:5px;'></div>"},
                        {
                            xtype: "compositefield",
                            items: [
                                // rewindDate,
                                {xtype: "container", width: 70, style:"align:right",
                                    html: "<span> To: </span>"},
                                tweetDateEndField
                                //forwardDate
                            ]
                        },

                        {xtype: "container",
                            html: "<div style='padding-bottom:5px;'></div>"},
                        {
                            xtype: "compositefield",
                            items: [
                                {xtype: "container", width: 70, style:"align:right",
                                    html: "<span> Increment:  </span>"},
                                {
                                    xtype: "combo",
                                    width: 75,
                                    id: "date_interval",
                                    triggerAction: 'all',
                                    mode: 'local',
                                    store:  [[Date.DAY, 'Day'], [Date.HOUR, 'Hour'],[Date.MINUTE, 'Minute' ], [Date.SECOND, 'Second']],
                                    value: Date.DAY,
                                    valueField: 'myId',
                                    displayField: 'displayText'
                                },
                                rewindDate,
                                forwardDate
                            ]
                        },
                        {
                            xtype: 'box',
                            id: 'dl_link_container',
                            hidden: true,
                            autoEl: {tag: 'a', id: "tweet_download_link",  target:"dl", href: '', html: 'Download Tweets'}
                        }
                    ]
                },
                {
                        columnWidth:0.4,
                       layout:"form",
                    labelWidth: 100,
                        //title:"3",
                        items:[
                            {xtype: "container",
                                html: "<div style='padding-bottom:10px;'></div>"},
                            {
                                xtype: "checkbox",
                                id: "auto_max_checkbox",
                                boxLabel: "Auto Max %",
                                style: "display:inline-block;",
                                checked: true,
                                listeners: {
                                    "change": updateLayer
                                }
                            },
                            {
                                xtype:"sliderfield",
                                id:"slider_maxval",
                                width: 100,
                                style: "display:inline-block;",
                                value: 0.02,
                                fieldLabel: "Max %",
                                labelStyle: "text-align:right;",
                                minValue: 0.01,
                                maxValue: 20,
                                increment: 0.01,
                                keyIncrement: 0.5,
                                decimalPrecision: 3,
                                listeners: {
                                    "changecomplete": updateLayer
                                }
                            },
                            {xtype:"sliderfield",
                                id:"slider_blur",
                                value:"28",
                                width: 100,
                                fieldLabel: "Smoothing",
                                labelStyle: "text-align:right;",
                                minValue: 1,
                                maxValue: 40,
                                listeners: {
                                    "changecomplete": updateLayer
                                }},
                            {xtype:"sliderfield",
                                id:"slider_min",
                                width: 100,
                                value:"30",
                                fieldLabel: "Min Tweets/sq km",
                                labelStyle: "text-align:right;",
                                minValue: 1,
                                maxValue: 1000,
                                listeners: {
                                    "changecomplete": updateLayer
                                }},
                            {

                            }

                        ]
                }
                ]
            }
        ],
        keys: [
            { key: [Ext.EventObject.ENTER], handler: updateLayer
            }
        ]
    });

var cqlWindow = new Ext.Window({
    id     : 'cql_window',
    style: 'opacity:0.9',
    width: 600,
    collapsible: true,
    draggable: true,
    closable: false,
    constrain: true,
    monitorResize: true,
    title: gettext('Tweet Filter'),
    items  : [cqlOverlay]
});

/*
Ext.chart.Chart.CHART_URL = '{{ GEONODE_CLIENT_LOCATION }}externals/ext/resources/charts.swf';


var chart = new Ext.chart.LineChart({
    store : remoteStore,
    xField : 'date', // 2
    listeners:{
        'itemclick' : function(obj) {
            tweetFilterField.setValue(chart.series[obj.seriesIndex].displayName);
//            var rec=store.getAt(obj.index);
//            Ext.Msg.alert('Series Index',obj.seriesIndex);
            updateLayer();
        }
    },
    extraStyle: {
        legend : {
            display: 'right',
            padding: 5,
            spacing: 2
        },
        yAxis: {
            titleRotation: -90
        }
    },
    yAxis: new Ext.chart.NumericAxis({
        title: "Tweets per Day"
    }),
    xAxis: new Ext.chart.CategoryAxis({
        labelSpacing: 200,
        calculateCategoryCount: true
    })
});


var chartPanel = new Ext.Panel({
    title: "Top 5 Trending Health Terms",
    width : 800,
    height : 200,
    layout : 'fit',
    cls: "chart-overlay",
    items : chart
});

*/

var tweetConfig = {title: "Twitter Trends", source: "local", group: "Twitter", name: "heatmap",
    url: "http://{{GEOPS_IP}}", srs: "EPSG:900913", format: "image/png", bbox: [-180,-90,180,90],
    singleTile: true, tiled: false, ratio: 1, opacity: 1, visibility: true, queryable: true
};
/*
var tweetConfig = {title: "Twitter Trends", source: "0", group: "Twitter", name: "point",
    url: "http://192.168.1.90:8081", srs: "EPSG:900913", format: "image/png", bbox: [-180,-90,180,90],
    singleTile: true, tiled: false, ratio: 1, opacity: 1, visibility: true
};
*/



var feedSource = Ext.ComponentMgr.createPlugin(
        tweetConfig, "gx_wmssource"
);
var tweetPointRecord = feedSource.createLazyLayerRecord(tweetConfig);
tweetPointRecord.set("name", "point");
tweetPointRecord.setLayer(new OpenLayers.Layer.WMS(
        "Tweets",
        tweetConfig.url, {
            layers: "point",
            transparent: "transparent" in tweetConfig ? tweetConfig.transparent : true,
            format: tweetConfig.format,
            tiled: false
        }, {
            singleTile: true,
            ratio: tweetConfig.ratio || 1,
            visibility: true,
            opacity: ("opacity" in tweetConfig) ? tweetConfig.opacity : 1,
            buffer: ("buffer" in tweetConfig) ? tweetConfig.buffer : 1,
            //transitionEffect: 'resize',
            projection: 'EPSG:900913'
        }
));
tweetPointRecord.group = tweetConfig.group;
tweetPointRecord.group = tweetConfig.group;

tweetPointRecord.getLayer().events.register("loadend", tweetPointRecord.getLayer(), function() {
    var tweet_cookie = get_cookie("tweet_count");
    if (tweet_cookie) {
        cqlWindow.setTitle(gettext("Tweet Filter:  ") + tweet_cookie + " tweets currently on map");
        if (tweet_cookie < 1000000 && is_authorized === "True") {
            Ext.getCmp("dl_link_container").show();
            Ext.getCmp("dl_link_container").getEl().dom.href = getDownloadLink();
        } else {
            Ext.getCmp("dl_link_container").hide();
        }
        delete_cookie("tweet_count");
    }

});

tweetConfig["queryable"] = false;
var tweetHeatRecord = feedSource.createLazyLayerRecord(tweetConfig);
tweetHeatRecord.setLayer(new OpenLayers.Layer.WMS(
        "Tweet Heatmap",
        tweetConfig.url, {
            layers: 'heatmap',
            transparent: "transparent" in tweetConfig ? tweetConfig.transparent : true,
            format: tweetConfig.format,
            tiled: false
        }, {
            singleTile: true,
            removeBackBufferDelay: 0,
            ratio: tweetConfig.ratio || 1,
            visibility: false,
            opacity: ("opacity" in tweetConfig) ? tweetConfig.opacity : 1,
            buffer: ("buffer" in tweetConfig) ? tweetConfig.buffer : 1,
            //transitionEffect: 'resize',
            projection: 'EPSG:900913'
        }
));
tweetHeatRecord.group = tweetConfig.group;

app.mapPanel.add(cqlWindow);

/*
app.mapPanel.add(chartPanel);
 */


app.on("setLayerTree", function() {
    app.layerTree.addCategoryFolder({"group":tweetHeatRecord.get("group")}, true);
    app.mapPanel.layers.add([tweetHeatRecord]);

    app.layerTree.addCategoryFolder({"group":tweetPointRecord.get("group")}, true);
    app.mapPanel.layers.add([tweetPointRecord]);

    app.toolbar.items.each(function(item) {
        if (item.text != undefined && item.text.indexOf(app.publishBtnText) > -1 ) {
            item.disable();
            item.hide();
        }
    });
});

app.on("ready", function() {

    app.mapPanel.layers.each(function (candidate) {
        //console.log("NAME:" + candidate.get("name"));
        if (candidate.get("name") == "heatmap" || candidate.get("name") == "point")
        {
            ////console.log("Remove saved heatmap");
            app.mapPanel.layers.remove(candidate, true);
            ////console.log("Successfully removed");
        }

    });

    tweetHeatRecord.getLayer().events.register("loadend", tweetHeatRecord.getLayer(), function(e) {

        var maxlevel_cookie = get_cookie("max_value");
        if (maxlevel_cookie) {
            Ext.getCmp("slider_maxval").setValue(maxlevel_cookie);
            //Ext.getCmp("slider_maxval").setValue(Math.random()*20);
            delete_cookie("max_value");
        }

        //updateLegend();

        if (!tweetPointRecord.getLayer().getVisibility()) {
                cqlWindow.setTitle(gettext("Tweet Filter:  "))
        }

    });

    updateLayer();

    cqlWindow.show();
    cqlWindow.alignTo(document, 'br-br?');

    app.mapPanel.map.events.register("moveend", app.mapPanel.map, function(e) {

        // var mapExtent = app.mapPanel.map.getExtent() ? app.mapPanel.map.getExtent() : config["map"]["maxExtent"];

        if (Math.floor(tweetDateEndField.getValue().getTime()) >=  Math.floor(firstEndDate)) {
            var rightNow = new Date();
            tweetDateEndField.setValue(rightNow);
            updateLayer();
        }
        /*
         remoteStore.load({
         params: {"bounds": app.mapPanel.map.getExtent() ? app.mapPanel.map.getExtent() : config["map"]["maxExtent"], "dateStart": new Date(tweetDateStartField.getValue()).format('Y-M-d'),  "dateEnd": new Date(tweetDateEndField.getValue()).format('Y-M-d')}
         });
         */
    }, this);

});




{% endautoescape %}
}

window.onload = init;

</script>

{% endblock %}

{% block body %}



<div id="header-wrapper">
  {{ block.super }}
<div id="dataTabs" class="x-hidden">

<div id="searchDiv" style="background-color:#fff;width:800px;">
<div style="float:left;position:relative;margin:10px;width:580px;">
  <div class="block">
    <h2>{% trans "Search" %} <span class="subtitle">{% trans "for geospatial data" %}</span></h2>

    <div id="search_results"></div>

  </div>

  <div class="block wrap selfclear">
  <h3>Selected Data</h3>
  <div id="selection">
    <div id="data_cart"></div>
    </div>
    <div id="data_ops">
    </div>
  </div>


</div>



<div style="position:relative;float:right;width:200px">
  <div id="refine" class="block">
    <h3>{% trans "Refine Search" %}</h3>
    <div class="bbox-controls">
      <div class="bbox-enabled"><input type="checkbox" /> {% trans "By area" %}</div>
      <p><span class="explain">{% blocktrans %}Limit the search to data that includes features in the displayed area.{% endblocktrans %}</span></p>
      <div class="bbox-expand">
      </div>
    </div>
    <div class="search-button">Refine</div>
  </div>

</div>
</div>
        <div id="externalDiv"></div>
        <div id="uploadDiv"></div>
        <div id="createDiv"></div>
        <div id="warpDiv">
            <div id="tabContainer" style="padding:20px;">

                <div style="position:relative;float:left;">

                    <h3>{%trans "Rectify Images"  %}</h3>    
                    
                    <p style="font-size: 14px">Use <a target="_blank" href="http://warp.worldmap.harvard.edu">WorldMap WARP</a> to upload and rectify scanned maps for use in WorldMap. <br/><br/> Maps rectified using this tool can be brought into WorldMap by following the instructions under Section 3.9.1 in <a href="http://localhost:8000/media/docs/WorldMap_Help.pdf">WorldMap Help</a>.</p>
                    <br/><br/>
                    <div align="center"><a target="_blank" href="http://warp.worldmap.harvard.edu"><img src="{{ STATIC_URL }}theme/img/warper-sample.jpg" border="0" /></a></div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

