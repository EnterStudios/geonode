{% extends "page_layout.html" %}
{% load i18n %}

{% block header_append %} 
<script  type="text/javascript">
        {% if map_status %} 
        /// the map status has some information
        var checkStatus = setInterval("update()",1000)

        function update() { 
            Ext.Ajax.request({ 
                url : "{% url geonode.maps.views.check_download %}",
                method: "GET",
                success: function(result) { 
                    var json = Ext.util.JSON.decode(result.responseText);
                    var count = 0 
                    if (json["process"]["status"] === "FINISHED"){ 
                        document.getElementById("progressBar").innerHTML = "Finished";                         
                        location.href = "http://localhost:8001/geoserver/rest/process/batchDownload/download/" +  json["process"]["id"] ; 
                        clearInterval(checkStatus); 
                        
                    } 
                    else { 
                        document.getElementById("progressBar").innerHTML = json["process"]["progress"] ;
                    } 
                },
                failure: function() { 
                    console.log("something went wrong"); 
                }});                 
                
        };
        
        window.onload = checkStatus; 

        {% else %} 
          // there is no information in the map_status
        {% endif %} 
    

</script>
{% endblock %} 

{% block main %}
    <h3>Download {{map.title}}</h3>
    <hr />
    <ol>
      {% for layer in map.layers %} 
      <li> {{layer.name}} </li>
    {% endfor %} 
     </ol>     
     {% if map_status %} 
        <div id="progressBar"><p>This should be a progress bar</p></div>
     {% else %} 
     <form action="." method="POST"> 
       <input type="submit" value="Start downloading this map" /> 
     </form>
     {% endif %} 

{% endblock %}
